{"version":3,"file":"link.js","sourceRoot":"","sources":["../../../../../src/cli/services/app/config/link.ts"],"names":[],"mappings":"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","sourcesContent":["import {saveCurrentConfig} from './use.js'\nimport {\n  AppConfiguration,\n  AppInterface,\n  CurrentAppConfiguration,\n  EmptyApp,\n  getAppScopes,\n  isCurrentAppSchema,\n  isLegacyAppSchema,\n} from '../../../models/app/app.js'\nimport {OrganizationApp} from '../../../models/organization.js'\nimport {selectConfigName} from '../../../prompts/config.js'\nimport {getAppConfigurationFileName, loadApp} from '../../../models/app/loader.js'\nimport {InvalidApiKeyErrorMessage, fetchOrCreateOrganizationApp, logMetadataForLoadedContext} from '../../context.js'\nimport {fetchAppDetailsFromApiKey, fetchAppExtensionRegistrations} from '../../dev/fetch.js'\nimport {configurationFileNames} from '../../../constants.js'\nimport {writeAppConfigurationFile} from '../write-app-configuration-file.js'\nimport {getCachedCommandInfo} from '../../local-storage.js'\nimport {PartnersSession, fetchPartnersSession} from '../../context/partner-account-info.js'\nimport {ExtensionRegistration} from '../../../api/graphql/all_app_extension_registrations.js'\nimport {ExtensionSpecification} from '../../../models/extensions/specification.js'\nimport {fetchSpecifications} from '../../generate/fetch-extension-specifications.js'\nimport {loadFSExtensionsSpecifications} from '../../../models/extensions/load-specifications.js'\nimport {BetaFlag, fetchAppRemoteBetaFlags} from '../select-app.js'\nimport {Config} from '@oclif/core'\nimport {renderSuccess} from '@shopify/cli-kit/node/ui'\nimport {AbortError} from '@shopify/cli-kit/node/error'\nimport {formatPackageManagerCommand} from '@shopify/cli-kit/node/output'\nimport {deepMergeObjects, isEmpty} from '@shopify/cli-kit/common/object'\nimport {joinPath} from '@shopify/cli-kit/node/path'\n\nexport interface LinkOptions {\n  commandConfig: Config\n  directory: string\n  apiKey?: string\n  configName?: string\n  baseConfigName?: string\n}\n\nexport default async function link(options: LinkOptions, shouldRenderSuccess = true): Promise<AppConfiguration> {\n  const {token, remoteApp, directory} = await selectRemoteApp(options)\n  const {localApp, configFileName, configFilePath} = await loadLocalApp(options, token, remoteApp, directory)\n\n  await logMetadataForLoadedContext(remoteApp)\n\n  let configuration = mergeAppConfiguration(\n    {...localApp.configuration, path: configFilePath},\n    remoteApp,\n    localApp.useVersionedAppConfig,\n  )\n  if (localApp.useVersionedAppConfig) {\n    const remoteAppConfigurationFromExtensions = await loadRemoteAppConfigurationFromExtensions(\n      token,\n      remoteApp,\n      localApp,\n    )\n    configuration = deepMergeObjects(configuration, remoteAppConfigurationFromExtensions)\n  }\n\n  await writeAppConfigurationFile(configuration, localApp.configSchema)\n  await saveCurrentConfig({configFileName, directory})\n\n  if (shouldRenderSuccess) {\n    renderSuccessMessage(configFileName, remoteApp, localApp, localApp.useVersionedAppConfig)\n  }\n\n  return configuration\n}\n\nasync function selectRemoteApp(options: LinkOptions) {\n  const localApp = await loadAppOrEmptyApp(options)\n  const directory = localApp?.directory || options.directory\n  const partnersSession = await fetchPartnersSession()\n  const remoteApp = await loadRemoteApp(localApp, options.apiKey, partnersSession, directory)\n  return {\n    token: partnersSession.token,\n    remoteApp,\n    directory,\n  }\n}\n\nasync function loadLocalApp(options: LinkOptions, token: string, remoteApp: OrganizationApp, directory: string) {\n  const specifications = await fetchSpecifications({\n    token,\n    apiKey: remoteApp.apiKey,\n    config: options.commandConfig,\n  })\n\n  const betas = await fetchAppRemoteBetaFlags(remoteApp.apiKey, token)\n  const localApp = await loadAppOrEmptyApp(options, specifications, betas, remoteApp)\n  const configFileName = await loadConfigurationFileName(remoteApp, options, localApp)\n  const configFilePath = joinPath(directory, configFileName)\n  return {\n    localApp,\n    configFileName,\n    configFilePath,\n  }\n}\n\nasync function loadAppOrEmptyApp(\n  options: LinkOptions,\n  specifications?: ExtensionSpecification[],\n  remoteBetas?: BetaFlag[],\n  remoteApp?: OrganizationApp,\n): Promise<AppInterface> {\n  try {\n    const app = await loadApp({\n      specifications,\n      directory: options.directory,\n      mode: 'report',\n      configName: options.baseConfigName,\n      remoteBetas,\n    })\n    const configuration = app.configuration\n    if (!isCurrentAppSchema(configuration) || remoteApp?.apiKey === configuration.client_id) return app\n    return new EmptyApp(await loadFSExtensionsSpecifications(), remoteBetas, remoteApp?.apiKey)\n    // eslint-disable-next-line no-catch-all/no-catch-all\n  } catch (error) {\n    return new EmptyApp(await loadFSExtensionsSpecifications(), remoteBetas)\n  }\n}\n\nasync function loadRemoteApp(\n  localApp: AppInterface,\n  apiKey: string | undefined,\n  partnersSession: PartnersSession,\n  directory?: string,\n): Promise<OrganizationApp> {\n  if (!apiKey) {\n    return fetchOrCreateOrganizationApp(localApp, partnersSession, directory)\n  }\n  const app = await fetchAppDetailsFromApiKey(apiKey, partnersSession.token)\n  if (!app) {\n    const errorMessage = InvalidApiKeyErrorMessage(apiKey)\n    throw new AbortError(errorMessage.message, errorMessage.tryMessage)\n  }\n  return app\n}\n\nasync function loadRemoteAppConfigurationFromExtensions(\n  token: string,\n  remoteApp: OrganizationApp,\n  localApp: AppInterface,\n) {\n  const remoteExtensionRegistrations = await fetchAppExtensionRegistrations({\n    token,\n    apiKey: remoteApp.apiKey,\n  })\n  return remoteAppConfigurationExtensionContent(\n    remoteExtensionRegistrations.app.configurationRegistrations,\n    localApp.specifications ?? [],\n  )\n}\n\nasync function loadConfigurationFileName(\n  remoteApp: OrganizationApp,\n  options: LinkOptions,\n  localApp: AppInterface,\n): Promise<string> {\n  const cache = getCachedCommandInfo()\n\n  if (!cache?.askConfigName && cache?.selectedToml) return cache.selectedToml as string\n\n  if (options.configName) {\n    return getAppConfigurationFileName(options.configName)\n  }\n\n  if (isLegacyAppSchema(localApp.configuration)) {\n    return configurationFileNames.app\n  }\n\n  const configName = await selectConfigName(localApp.directory || options.directory, remoteApp.title)\n  return `shopify.app.${configName}.toml`\n}\n\nexport function mergeAppConfiguration(\n  appConfiguration: AppConfiguration,\n  remoteApp: OrganizationApp,\n  useVersionedAppConfig: boolean,\n): CurrentAppConfiguration {\n  return {\n    ...addLocalAppConfig(appConfiguration, remoteApp, useVersionedAppConfig),\n    ...addBrandingConfig(remoteApp),\n    ...addPosConfig(remoteApp),\n    ...addRemoteAppWebhooksConfig(remoteApp),\n    ...addRemoteAppAccessConfig(appConfiguration, remoteApp),\n    ...addRemoteAppProxyConfig(remoteApp),\n    ...addRemoteAppHomeConfig(remoteApp),\n  }\n}\n\nfunction addRemoteAppHomeConfig(remoteApp: OrganizationApp) {\n  const homeConfig = {\n    application_url: remoteApp.applicationUrl.replace(/\\/$/, ''),\n    embedded: remoteApp.embedded === undefined ? true : remoteApp.embedded,\n  }\n  return remoteApp.preferencesUrl\n    ? {\n        ...homeConfig,\n        app_preferences: {\n          url: remoteApp.preferencesUrl,\n        },\n      }\n    : {...homeConfig}\n}\n\nfunction addRemoteAppProxyConfig(remoteApp: OrganizationApp) {\n  return remoteApp.appProxy?.url\n    ? {\n        app_proxy: {\n          url: remoteApp.appProxy.url,\n          subpath: remoteApp.appProxy.subPath,\n          prefix: remoteApp.appProxy.subPathPrefix,\n        },\n      }\n    : {}\n}\n\nfunction addRemoteAppWebhooksConfig(remoteApp: OrganizationApp) {\n  const hasAnyPrivacyWebhook =\n    remoteApp.gdprWebhooks?.customerDataRequestUrl ||\n    remoteApp.gdprWebhooks?.customerDeletionUrl ||\n    remoteApp.gdprWebhooks?.shopDeletionUrl\n\n  const privacyComplianceContent = {\n    privacy_compliance: {\n      customer_data_request_url: remoteApp.gdprWebhooks?.customerDataRequestUrl,\n      customer_deletion_url: remoteApp.gdprWebhooks?.customerDeletionUrl,\n      shop_deletion_url: remoteApp.gdprWebhooks?.shopDeletionUrl,\n    },\n  }\n\n  return {\n    webhooks: {\n      api_version: remoteApp.webhookApiVersion || '2023-07',\n      ...(hasAnyPrivacyWebhook ? privacyComplianceContent : {}),\n    },\n  }\n}\n\nfunction addRemoteAppAccessConfig(appConfiguration: AppConfiguration, remoteApp: OrganizationApp) {\n  let accessScopesContent = {}\n  // if we have upstream scopes, use them\n  if (remoteApp.requestedAccessScopes) {\n    accessScopesContent = {\n      scopes: remoteApp.requestedAccessScopes.join(','),\n    }\n    // if we can't find scopes or have to fall back, omit setting a scope and set legacy to true\n  } else if (getAppScopes(appConfiguration) === '') {\n    accessScopesContent = {\n      use_legacy_install_flow: true,\n    }\n    // if we have scopes locally and not upstream, preserve them but don't push them upstream (legacy is true)\n  } else {\n    accessScopesContent = {\n      scopes: getAppScopes(appConfiguration),\n      use_legacy_install_flow: true,\n    }\n  }\n  return {\n    auth: {\n      redirect_urls: remoteApp.redirectUrlWhitelist,\n    },\n    access_scopes: accessScopesContent,\n  }\n}\n\nfunction addLocalAppConfig(\n  appConfiguration: AppConfiguration,\n  remoteApp: OrganizationApp,\n  useVersionedAppConfig: boolean,\n) {\n  let localAppConfig = {\n    ...appConfiguration,\n    client_id: remoteApp.apiKey,\n  }\n  if (isCurrentAppSchema(localAppConfig)) {\n    delete localAppConfig.auth\n    const build = {\n      ...(useVersionedAppConfig && remoteApp.newApp ? {include_config_on_deploy: true} : {}),\n      ...(appConfiguration.client_id === remoteApp.apiKey ? localAppConfig.build : {}),\n    }\n    if (isEmpty(build)) {\n      delete localAppConfig.build\n    } else {\n      localAppConfig = {\n        ...localAppConfig,\n        build,\n      }\n    }\n  }\n  return localAppConfig\n}\n\nfunction addPosConfig(remoteApp: OrganizationApp) {\n  return {\n    pos: {\n      embedded: remoteApp.posEmbedded || false,\n    },\n  }\n}\n\nfunction addBrandingConfig(remoteApp: OrganizationApp) {\n  return {\n    name: remoteApp.title,\n  }\n}\n\nexport function remoteAppConfigurationExtensionContent(\n  configRegistrations: ExtensionRegistration[],\n  specifications: ExtensionSpecification[],\n) {\n  let remoteAppConfig: {[key: string]: unknown} = {}\n  const configSpecifications = specifications.filter((spec) => spec.appModuleFeatures().includes('app_config'))\n  configRegistrations.forEach((extension) => {\n    const configSpec = configSpecifications.find((spec) => spec.identifier === extension.type.toLowerCase())\n    if (!configSpec) return\n    const configExtensionString = extension.activeVersion?.config\n    if (!configExtensionString) return\n    const configExtension = configExtensionString ? JSON.parse(configExtensionString) : {}\n\n    remoteAppConfig = deepMergeObjects(\n      remoteAppConfig,\n      configSpec.reverseTransform?.(configExtension) ?? configExtension,\n    )\n  })\n  return {...remoteAppConfig}\n}\n\nfunction renderSuccessMessage(\n  configFileName: string,\n  remoteApp: OrganizationApp,\n  localApp: AppInterface,\n  useVersionedAppConfig: boolean,\n) {\n  renderSuccess({\n    headline: `${configFileName} is now linked to \"${remoteApp.title}\" on Shopify`,\n    body: `Using ${configFileName} as your default config.`,\n    nextSteps: [\n      [`Make updates to ${configFileName} in your local project`],\n      [\n        'To upload your config, run',\n        {\n          command: formatPackageManagerCommand(\n            localApp.packageManager,\n            `shopify app ${useVersionedAppConfig ? 'deploy' : 'config push'}`,\n          ),\n        },\n      ],\n    ],\n    reference: [\n      {\n        link: {\n          label: 'App configuration',\n          url: 'https://shopify.dev/docs/apps/tools/cli/configuration',\n        },\n      },\n    ],\n  })\n}\n"]}